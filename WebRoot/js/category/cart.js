Utils.pkg("CartSys.cartService");CartSys.cartService.config={prdType:{PRODUCT:"1",BUNDLER:"2",EXTEND:"6"},url:{ADD_CART:"/cart/add.json?",DEL_CART:"/cart/del.json?",MERGE_CART:"/cart/cache2cart.json?",INDEX_CART:"/cart/shoppingCart.json?",UPDATE_CART:"/cart/updateNum.json?"}};CartSys.cartService.index=function(){var a={};a.url=CartSys.cartService.config.url.INDEX_CART;a.callback=function(b){ecWap.cartService.queryCartProductInfo(b)};if(!CartSys.cartService.utils.isEmpty(Utils.cookie.get("cartId"))&&!CartSys.cartService.utils.isEmpty(Utils.cookie.get("uid"))){CartSys.cartService.merge(function(b){CartSys.cartService.utils.getJSON(a)})}else{CartSys.cartService.utils.getJSON(a)}};CartSys.cartService.add=function(b,c){var a={};a.url=CartSys.cartService.config.url.ADD_CART;a.data=CartSys.cartService.utils.buildAddCartQueryData(b);a.callback=function(d){if(d.success){ecWap.alert("\u6dfb\u52a0\u5546\u54c1\u6210\u529f");if(CartSys.cartService.utils.isFunction(c)){c(d)}}else{ecWap.alert("\u6dfb\u52a0\u5546\u54c1\u5931\u8d25")}};CartSys.cartService.utils.getJSON(a)};CartSys.cartService.del=function(b,c){var a={};a.url=CartSys.cartService.config.url.DEL_CART;if(CartSys.cartService.utils.isEmpty(b)){ecWap.alert("\u8bf7\u9009\u62e9\u60a8\u8981\u5220\u9664\u7684\u4e3b\u5546\u54c1");return}else{a.callback=function(d){ecWap.cartService.queryCartProductInfo(d);if(CartSys.cartService.utils.isFunction(c)){c(d)}};a.data=CartSys.cartService.utils.buildQueryData(b);CartSys.cartService.utils.getJSON(a)}};CartSys.cartService.update=function(b,c){var a={};a.url=CartSys.cartService.config.url.UPDATE_CART;if(CartSys.cartService.utils.isEmpty(b)){ecWap.alert("\u8bf7\u9009\u62e9\u60a8\u8981\u4fee\u6539\u7684\u5546\u54c1")}else{a.data=CartSys.cartService.utils.buildUpdateQueryData(b);a.callback=function(d){ecWap.cartService.queryCartProductInfo(d);if(CartSys.cartService.utils.isFunction(c)){c(d)}};CartSys.cartService.utils.getJSON(a)}};CartSys.cartService.merge=function(b){var a={};a.url=CartSys.cartService.config.url.MERGE_CART;a.callback=function(c){b(c)};CartSys.cartService.utils.getJSON(a)};CartSys.cartService.getCarPrdNum=function(b){if(!CartSys.cartService.utils.isEmpty(Utils.cookie.get("cartId"))&&!CartSys.cartService.utils.isEmpty(Utils.cookie.get("uid"))){CartSys.cartService.merge(function(d){var c={};c.url=CartSys.cartService.config.url.INDEX_CART;c.callback=function(e){new ecWap.ajax({url:"/shoppingCart/filterPrd.json?cartPrdInfo="+JSON.stringify(e),timeout:10000,timeoutFunction:function(){ecWap.alert("\u64cd\u4f5c\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5\uff01")},successFunction:function(g){if(!g.success){ecWap.alert(g.msg);return}var f=0;$.each(g.PrdIdsInfo.cart,function(h,i){if(!CartSys.cartService.utils.isEmpty(i.quantity)){f+=parseInt(i.quantity)}});b(f)}})};CartSys.cartService.utils.getJSON(c)})}else{var a={};a.url=CartSys.cartService.config.url.INDEX_CART;a.callback=function(c){new ecWap.ajax({url:"/shoppingCart/filterPrd.json?cartPrdInfo="+JSON.stringify(c),timeout:10000,timeoutFunction:function(){ecWap.alert("\u64cd\u4f5c\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5\uff01")},successFunction:function(e){if(!e.success){ecWap.alert(e.msg);return}var d=0;$.each(e.PrdIdsInfo.cart,function(f,g){if(!CartSys.cartService.utils.isEmpty(g.quantity)){d+=parseInt(g.quantity)}});b(d)}})};CartSys.cartService.utils.getJSON(a)}};CartSys.cartService.utils={isFunction:function(a){return Object.prototype.toString.call(a)==="[object Function]"},isEmpty:function(a){return("undefined"==a||null==a||""==a||0==a.length)},buildQueryData:function(c){var e=[],d=[],a=[],g=[],f=[],b=[];$.each(c,function(h,i){switch(i.productType){case CartSys.cartService.config.prdType.PRODUCT:e.push(i.skuId);d.push(i.productType);a.push(i.quantity);g.push("");f.push(i.skuId+":"+i.quantity);break;case CartSys.cartService.config.prdType.BUNDLER:e.push(i.bundleId);d.push(i.productType);a.push(i.quantity);g.push("");b.push(i.bundleId+":"+i.quantity);break;case CartSys.cartService.config.prdType.EXTEND:e.push(i.skuId);d.push(i.productType);a.push(i.quantity);g.push(i.mainSkuId);f.push(i.skuId+":"+i.quantity);break;default:break}});return{sbs:e.join(","),types:d.join(","),qtys:a.join(","),ess:g.join(","),skuIdAndQtys:f.join(","),bundlerIdAndQtys:b.join(","),t:new Date().getTime()}},buildAddCartQueryData:function(b){var d=[],c=[],a=[],e=[];$.each(b,function(f,g){switch(g.productType){case CartSys.cartService.config.prdType.PRODUCT:d.push(g.skuId);c.push(g.productType);a.push(g.quantity);e.push("");break;case CartSys.cartService.config.prdType.BUNDLER:d.push(g.bundleId);c.push(g.productType);a.push(g.quantity);e.push("");break;case CartSys.cartService.config.prdType.EXTEND:d.push(g.skuId);c.push(g.productType);a.push(g.quantity);e.push(g.mainSkuId);break;default:break}});return{sbs:d.join(","),type:c.join(","),qty:a.join(","),ess:e.join(","),t:new Date().getTime()}},buildUpdateQueryData:function(b){var d=[],c=[],a=[],e=[];$.each(b,function(f,g){switch(g.productType){case CartSys.cartService.config.prdType.PRODUCT:d.push(g.skuId);c.push(g.productType);a.push(g.quantity);e.push("");break;case CartSys.cartService.config.prdType.BUNDLER:d.push(g.bundleId);c.push(g.productType);a.push(g.quantity);e.push("");break;case CartSys.cartService.config.prdType.EXTEND:d.push(g.skuId);c.push(g.productType);a.push(g.quantity);e.push(g.mainSkuId);break;default:break}});return{sbs:d.join(","),types:c.join(","),qty:a.join(","),ess:e.join(",")}},getJSON:function(b){if(CartSys.cartService.utils.isEmpty(b)||CartSys.cartService.utils.isEmpty(b.url)||(!CartSys.cartService.utils.isFunction(b.callback))){return false}var a=cartDomain+b.url+"&_t="+new Date().getTime()+"&callback=?";$.getJSON(a,b.data,function(c){if(c.success){b.callback(c)}else{ecWap.alert("\u7cfb\u7edf\u5f02\u5e38\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\uff01")}});return true}};
